# FIXME wrapper.html is hard-coded
srcdir = @srcdir@
VPATH = @srcdir@
SUBDIRS = SLAB base2 sizzle NWEvents

include @top_srcdir@/mk/gnu.bsdvars.mk

.SUFFIXES: .html .html .xml .css
RESOURCES = init.js
TARGET_FILES = index.html
TARGETS += ${foreach FILE,${TARGET_FILES},${.CURDIR}/${FILE}}

XSLTPROC = /usr/bin/xsltproc --novalid 
TIDY = /usr/bin/tidy -q
URLINSTALL = ~/bin/URL-Utils-0.6/url-install
HTMLPP = ~/bin/HTMLPP-0.7/htmlpp
HTMLWRAP = ~/bin/HTMLPP-0.7/htmlwrap

DOM_SCRIPT_URL ?= ${libexecdir}/DOM.js
PARAMS += --stringparam DOM_SCRIPT_URL ${DOM_SCRIPT_URL}
PARAMS += --stringparam XBL_SCRIPT_URL ${pkglibexecdir}/libXBL.js
PARAMS += --stringparam pkgdefaultlibdir ${pkgdefaultlibdir}

all: build

clean: clean-subdirs
	-rm ${TARGETS}
	-rm wrapper.html # FIXME

build: build-subdirs ${.CURDIR}/wrapper.html ${TARGETS}

install: install-subdirs ${TARGET_FILES} ${RESOURCES}
	for FILE in ${TARGET_FILES}; do \
		${URLINSTALL} $${FILE} ${pkgdemodir}/$${FILE}; \
	done;
	for FILE in ${RESOURCES}; do \
		${URLINSTALL} ${srcdir}/$${FILE} ${pkgdemodir}/$${FILE}; \
	done;

clean-subdirs: 
	for dir in ${SUBDIRS}; do make -C $${dir} clean; done

build-subdirs: 
	for dir in ${SUBDIRS}; do make -C $${dir} build; done

install-subdirs: 
	for dir in ${SUBDIRS}; do make -C $${dir} install; done

${TARGETS}: ${.CURDIR}/%.html: ${srcdir}/%.html 
	${HTMLPP} ${PARAMS} ${.IMPSRC} |\
	${HTMLWRAP} --wrapper wrapper.html - > ${.TARGET}

${.CURDIR}/wrapper.html: ${srcdir}/wrapper.html
	${HTMLPP} ${PARAMS} ${.IMPSRC} > ${.TARGET}
